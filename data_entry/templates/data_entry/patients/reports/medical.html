{% load static %}
<!DOCTYPE html>
<html>
    <head>
        <title>Medical Report</title>
        <link href="{% static 'plugins/bootstrap/css/bootstrap.min.css' %}" rel="stylesheet" />
        <link href="{% static 'plugins/jquery-ui/themes/base/minified/jquery-ui.min.css' %}" rel="stylesheet" />
        <link href="{% static '/plugins/bootstrap-tagsinput/bootstrap-tagsinput.css' %}" rel="stylesheet" />
        <link href="{% static 'plugins/jquery-tag-it/css/jquery.tagit.css' %}" rel="stylesheet" />
        <link href="{% static 'plugins/font-awesome/css/font-awesome.min.css' %}" rel="stylesheet" />
        <script src="{% static 'plugins/jquery/jquery-1.9.1.min.js' %}"></script>
        <script src="{% static 'plugins/jquery/jquery-migrate-1.1.0.min.js' %}"></script>
        <script src="{% static 'plugins/jquery-ui/ui/minified/jquery-ui.min.js' %}"></script>
        <script src="{% static 'plugins/bootstrap/js/bootstrap.min.js' %}"></script>
        <script src="{% static 'plugins/bootstrap-tagsinput/bootstrap-tagsinput.min.js' %}"></script>
        <script src="{% static 'plugins/bootstrap-tagsinput/bootstrap-tagsinput-typeahead.js' %}"></script>
        <script src="{% static 'plugins/jquery-tag-it/js/tag-it.min.js' %}"></script>

        <style>
            hr {
                margin-top:2px;
                margin-bottom: 2px;
            }

            table th{
                white-space: nowrap;
            }

            table td, th{
                padding:0px !important;
                border-top: none !important;
            }

            @media print{
                body {
                    padding: 5px 10px!important;
                }

                blockquote {
                    border: none;
                }

                .no-print, .no-print *{
                    display: none !important;
                }
            }

            .therapy-recommendations {
                width: 100%;
            }

            .therapy-recommendations h2 {
                font-size: 18px;
            }

            .therapy-recommendations h3 {
                margin: 0px;
                font-size: 16px;
            }

            .therapy-recommendations h4 {
                margin: 0px;
                font-size: 14px;
            }

            .therapy-recommendations td {
                vertical-align: top;
                text-align: center;
            }

            .therapy-recommendations th h3 {
                font-size: 24px;
                font-weight: 500;
                vertical-align: top;
                text-align: center;
                margin: 0px;
                padding: 0px;   
             }
            .icon-img {
                width: 25px;
                height: 25px;
                border:2px solid #fff;
            }
             @media print {
                a[href]:after {
                    content: none !important;
                }
            }
        </style>
    </head>
    <body style="padding:20px 300px;">
        <div class="btn-group no-print" role="group" aria-label="...">
          <button type="button" class="btn btn-default btn-lg" onclick="window.print();">Print</button>
          <div class="btn-group" role="group">
            <button type="button" class="btn btn-default btn-lg dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              Email
              <span class="caret"></span>
            </button>
            <ul class="dropdown-menu" style="padding:5px">
              <li>
                <div id="email_results_input" class="input-group m-t-20" style="width:500px">
                    <ul id="jquery-tagIt-default">
                    </ul>

                    <div class="input-group-btn">
                        <button id="send" type="button" class="btn btn-default btn-primary" data-loading-text="Sending...">Send</button>
                    </div>
                </div>
                <div id="email-message" style="display:none;"></div>
              </li>
            </ul>
          </div>
        </div>


        <h2 class="text-center" style="font-weight:500;">TRIPLE THERAPY REPORT: Patient Data</h2>

        <h3>Personal Information</h3>
        <hr />
        <table class="table" style="width:100%;border:none;">
            <thead>
                <tr>
                    <td style="width:30%"></td>
                    <td style="width:16%"></td>
                    <td style="width:4%"></td>
                    <td style="width:28%"></td>
                    <td style="width:22%"></td>
                </tr>
            </thead>

            <tbody>
                <tr>
                    <th>Identification Number</th>
                    <td>{{ patient.identification }}</td>
                    <td></td>
                    <th>Initials</th>
                    <td>{{ patient.initials }}</td>
                </tr>

                <tr>
                    <th>Gender</th>
                    <td>{{ patient.get_gender_display }}</td>
                    <td></td>
                    <th>Age</th>
                    <td>{{ patient.age }}</td>
                </tr>
                <tr>
                    <th>Weight</th>
                    <td>{{ patient.weight }} kg</td>
                    <td></td>
                    <th></th>
                    <td></td>
                </tr>
            </tbody>
        </table>

        <h3>High-risk angiographic features</h3>
        <hr>
        <table class="table" style="width: 100%;border:none">
            <thead>
                <tr>
                    <td style="width:40%"></td>
                    <td style="width:8%"></td>

                    <td style="width:4%"></td>

                    <td style="width:40%"></td>
                    <td style="width:8%"></td>
                </tr>
            </thead>

            <tbody>

                <tr>
                    <th>Multi-vessel PCI</th>
                    <td>{{ patient.pci_risk_1 | yesno | title }}</td>
                    <td></td>
                    <th>Multiple stents implanted (&gt;3 stents implanted, &lt;3 lesions stented)</th>
                    <td>{{ patient.pci_risk_2 | yesno | title }}</td>
                </tr>
                <tr>
                    <th>Complex bifurcation lesion (treated with 2 stents)</th>
                    <td>{{ patient.pci_risk_3 | yesno | title }}</td>
                    <td></td>
                    <th>Total stent length &gt; 60mm</th>
                    <td>{{ patient.pci_risk_4 | yesno | title }}</td>
                </tr>
                <tr>
                    <th>Total Occlusion intervation</th>
                    <td>{{ patient.pci_risk_5 | yesno | title }}</td>
                    <td></td>
                    <th>Bioabsorbable Vascular Scaffold (MVS) implantation</th>
                    <td>{{ patient.pci_risk_6 | yesno | title }}</td>
                </tr>
                <tr>
                    <th>Left main or proximal LAD stenting</th>
                    <td>{{ patient.pci_risk_7 | yesno | title }}</td>
                    <td></td>
                    <th></th>
                    <td></td>
                </tr>

            </tbody>
        </table>

        <h3>Procedure Details</h3>
        <hr/>
        <table class="table" style="width:100%;border:none;">
            <thead>
                <tr>
                    <td style="width:30%"></td>
                    <td style="width:16%"></td>
                    <td style="width:4%"></td>
                    <td style="width:28%"></td>
                    <td style="width:22%"></td>
                </tr>
            </thead>

            <tbody>

                <tr>
                    <th>Bare-Metal Stent (BMS)</th>
                    <td>{{ patient.bms_stent | yesno | title }}</td>
                    <td></td>
                    <th>Drug-Coated Stent (DCS)</th>
                    <td>{{ patient.drug_coated_stent | yesno | title }}</td>
                </tr>

                <tr>
                    <th>Drug-Eluting Stent (DES)</th>
                    <td>{{ patient.des_stent | yesno | title }}</td>
                    <td></td>
                    <th>Plain Old Balloon Angioplasty (POBA)</th>
                    <td>{{ patient.poba | yesno | title }}</td>
                </tr>

                <tr>
                    <th>Bioabsorbable Vascular Scaffold (BVS)</th>
                    <td>{{ patient.bvs | yesno | title }}</td>
                    <td></td>
                    <th>Drug Eluting Balloon (DEB)</th>
                    <td>{{ patient.deb | yesno | title }}</td>
                </tr>
            </tbody>
        </table>

        <h3>Atrial Fibrillation</h3>
        <hr/>
        <table class="table" style="width:100%;border:none;">
            <thead>
                <tr>
                    <td style="width:30%"></td>
                    <td style="width:16%"></td>
                    <td style="width:4%"></td>
                    <td style="width:28%"></td>
                    <td style="width:22%"></td>
                </tr>
            </thead>

            <tbody>
                <tr>
                    <th>Type of Atrial Fibrillation</th>
                    <td>{{ patient.get_af_type_display }}</td>
                    <td></td>
                    <th>Previous Anticoagulation</th>
                    <td>{{ patient.get_prev_anti_coagulation_display }}</td>
                </tr>

                <tr>
                    <th>Indication</th>
                    <td>{{ patient.get_elective_pci_display }}</td>
                    <td></td>
                    <th>INR Instability</th>
                    <td>{{ patient.inr_instability|yesno|capfirst }}</td>
                </tr>

                <tr>
                    <th>Warfarin Intolerance</th>
                    <td>{{ patient.warfarin_intolerance|yesno|capfirst }}</td>
                    <td></td>
                    <th>DOAC Allergy Or Intolerance</th>
                    <td>{{ patient.doac_allergy_or_intolerance|yesno|capfirst }}</td>
                </tr>
            </tbody>
        </table>

        <h3>Medical History</h3>
        <hr/>
        <table class="table" style="width:100%;border:none;">
            <thead>
                <tr>
                    <td style="width:30%"></td>
                    <td style="width:16%"></td>
                    <td style="width:4%"></td>
                    <td style="width:28%"></td>
                    <td style="width:22%"></td>
                </tr>
            </thead>

            <tbody>
                    <tr>
                        <th>Smoking History</th>
                        <td>{{ patient.get_smoking_history_display }}</td>
                        <td></td>
                        <th></th>
                        <td></td>
                    </tr>
                    
                <tr>
                    <th>Hypertension</th>
                    <td>{{ patient.get_htn_display }}</td>

                    <td></td>

                    <th>Vascular Disease</th>
                    <td>{{ patient.get_vascular_disease_display }}</td>
                </tr>

                <tr>
                    <th>History Of Bleeding</th>
                    <td>{{ patient.get_hx_of_bleeding_display }}</td>

                    <td></td>

                    <th>Alcohol Abuse</th>
                    <td>{{ patient.get_alcohol_abuse_display }}</td>
                </tr>

                <tr>
                    <th>Prior Acute Coronary Syndrome (ACS)</th>
                    <td>{{ patient.prior_acute_cs|yesno|capfirst }}</td>

                    <td></td>

                    <th>Prior stent thrombosis</th>
                    <td>{{ patient.prior_stent_thrombosis|yesno|capfirst }}</td>
                </tr>

                <tr>
                    <th>Frailty</th>
                    <td>{{ patient.frailty|yesno|capfirst }}</td>

                    <td></td>

                    <th><th>
                    <td></td>
                </tr>

                <tr>
                    <th>Congestive Heart Failure</th>
                    <td>{{ patient.chf|yesno|capfirst }}</td>

                    <td></td>

                    <th>Diabetes Mellitus</th>
                    <td>{{ patient.diabetes_mellitus|yesno|capfirst }}</td>
                </tr>

                <tr>
                    <th>ASA Allergy</th>
                    <td>{{ patient.asa_allergy|yesno|capfirst }}</td>

                    <td></td>
                    
                    <th>TIA, Stroke, or Systemic Embolism</th>
                    <td>{{ patient.tia_stroke_or_sysemb|yesno|capfirst }}</td>
                </tr>

                <tr>
                    <th>Renal Dysfunction</th>
                    <td>{{ patient.renal_dysfunction|yesno|capfirst }}</td>

                    <td></td>

                    <th>Drug Abuse</th>
                    <td>{{ patient.drug_abuse|yesno|capfirst }}</td>
                </tr>
                <tr>
                    <th>Liver Dysfunction</th>
                    <td>{{ patient.liver_dysfunction|yesno|capfirst }}</td>

                    <td></td>
                    
                    <th>Use of antiplatelet agents, <br>NSAIDs, or other anti-inflammatory meds</th>
                    <td>{{ patient.aim|yesno|capfirst }}</td>
                </tr>

                <tr>
                    <th>History Of Anemia</th>
                    <td>{{ patient.hxoa_anemia|yesno|capfirst }}</td>

                    <td></td>
                    
                    <th>Hemoglobin &lt;110 g/L or &lt;11 g/dL</th>
                    <td>{{ patient.hemoglobin_anemia|yesno|capfirst }}</td>
                </tr>

                <tr>
                    <th>Anemia</th>
                    <td>{{ patient.anemia|yesno|capfirst }}</td>

                    <td></td>

                    <th>Creatinine</th>
                    {% if patient.creatinine_mgdL != None %}
                    <td>
                        {{ patient.creatinine_mgdL }} mg/dL<br>
                        <i>({{patient.creatinine_umolL}} μmol/L)</i>
                    </td>
                    {% else %}
                    <td>N/A</td>
                    {% endif %}
                </tr>

            </tbody>
        </table>
        <hr>
        <table class="table" style="width: 100%;border:none;">
            <thead>
                <tr>
                    <td style="width:30%"></td>
                    <td style="width:70%"></td>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <th class="text-center">
                        <h3>eGFR</h3>
                    </th>
                    <th class="text-center">
                        <h3>{{ patient.gfr_mLmin|floatformat:2 }} <small>mL/min</small></h3>
                    </th>
                </tr>
            </tbody>
        </table>
        <hr>

        <center style="font-weight:bolder">www.tripletherapy.net</center>
        <!-- *************************** PAGE BREAK ****************************** -->
        <div style="page-break-after: always;"></div>

        <h2 class="text-center" style="font-weight:500;">TRIPLE THERAPY REPORT: Results</h2>

        <h3>Scores and Risks</h3>
        <hr />

        <h4>CHADS<sub>2</sub></h4>
        <table class="table" style="width:100%;border:none;">
            <thead>
                <tr>
                    <td style="width:20%;">
                    <td style="width:80%;">
                </td>
            </tr>
            <tbody>
                <tr>
                    <th>Score</th>
                    <td class="text-left">{{ patient.chads2_score }}</td>
                </tr>

                <tr>
                    <th>Associated Risk</th>
                    <td class="text-left">{{ patient.chads2_risk.percentage }}% <small> ({{ patient.chads2_risk.ci }}) 95% C.I.</small></td>
                </tr>
            </tbody>
        </table>

        <br/>

        <h4>CHA<sub>2</sub>DS<sub>2</sub>-VASc</h4>
        <table class="table" style="width:100%;border:none;">
            <thead>
                <tr>
                    <td style="width:20%;">
                    <td style="width:80%;">
                </td>
            </tr>
            <tbody>
                <tr>
                    <th>Score</th>
                    <td class="text-left">{{ patient.cha2_score }}</td>
                </tr>

                <tr>
                    <th>Associated Risk</th>
                    <td class="text-left">{{ patient.cha2_risk.percentage }}%</td>
                </tr>
            </tbody>
        </table>

        <br/>

        <h4>HAS-BLED</h4>
        <table class="table" style="width:100%;border:none;">
            <thead>
                <tr>
                    <td style="width:20%;">
                    <td style="width:80%;">
                </td>
            </tr>
            <tbody>
                <tr>
                    <th>Score</th>
                    <td class="text-left">{{ patient.hasbled_score }}</td>
                </tr>

                <tr>
                    <th>Associated Risk</th>
                    <td class="text-left">{{ patient.hasbled_risk.percentage }}%</td>
                </tr>
            </tbody>
        </table>

        <center style="font-weight:bolder">www.tripletherapy.net</center>
        <!-- *************************** PAGE BREAK ****************************** -->
        <div style="page-break-after: always;"></div>

        <h2 class="text-center" style="font-weight:500;">TRIPLE THERAPY REPORT: Therapy</h2>

        <table class="therapy-recommendations">
            <thead>
                <tr>
                    <th style="width:100%;" colspan="2"><h3>Hamilton AF-PCI recommendation</h3></th>
                </tr>
                <tr>
                    <th colspan="2"><hr/></th>
                </tr>
            </thead>

            <tbody>
                {% for choice in patient.parse_ccs_therapy.choices %}
                    {% for step in choice.steps %}
                    <tr>
                        <td>
                            <h3>OPTION UP TO 12 MONTHS</h3>
                            {{ step.option|safe }}
                        </td>
                        <td>
                            <h3>OPTION AFTER 12 MONTHS</h3>
                            {% if step.extra %}
                                {{ step.extra|safe }}
                            {% endif %}
                        </td>
                    {% endfor %}
                    {% empty %}
                        <td><h2>Nothing here</h2></td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>

        <center style="font-weight:bolder">www.tripletherapy.net</center>
        <!-- *************************** PAGE BREAK ****************************** -->
        <div style="page-break-after: always;"></div>

        <h3>Do you agree with the recommendation?</h3>
        <hr />

        <p class="lead"><span class="big"><b>{{ patient.agree_therapy | yesno | title }}</b></span>.</p>

        <p class="lead">Reason: <b>"{{ patient.reason }}"</b></p>

        <p class="f-w-700" style="text-align:center;">Report generated on {% now "d/m/Y" %} by {{ user.guess_user_name }} ({{ user.email }})</p>
        <center style="font-weight:bolder">www.tripletherapy.net</center>

        <script>
            function showEmailSuccessMessage(){
                $('#email-message').css('color', 'green').html('Email has been sent!').show();
            }

            function showEmailErrorMessage(){
                $('#email-message').css('color', 'red').html('Error sending email!').show();
            }

            function clearEmailMessage(){
                $('#email-message').hide().html('');
            }

            $('#jquery-tagIt-default').tagit();

            $('#jquery-tagIt-default').find('input').on('keyup', function(e){
                $(this).parent().removeClass('has-error');
                $(this).parent().removeClass('has-success');
                clearEmailMessage();
            });

            // stop the dropdown from closing when you click on it
            $('.dropdown-menu').on('click', function(e){e.stopPropagation();});

            $('#send').on('click', function(e){
                e.stopPropagation();
                var sendButton = $(this);

                var tagitInput = $('#jquery-tagIt-default');
                var addresses = tagitInput.tagit("assignedTags");

                if (addresses.length == 0){
                    tagitInput.parent().addClass('has-error');
                    return;
                }else{
                    tagitInput.parent().removeClass('has-error');
                }

                sendButton.button('loading');
                tagitInput.parent().removeClass('has-error');
                tagitInput.parent().removeClass('has-success');

                var request = $.ajax({
                    url: 'email',
                    type: 'POST',
                    data: {'addresses': addresses},
                });

                request.done(function(data, textStatus, jqXHR) {
                    console.log('Success');
                    console.log(data);
                    sendButton.button('reset');
                    tagitInput.parent().addClass('has-success');
                    showEmailSuccessMessage();
                });

                request.fail(function(jqXHR, textStatus, errorThrown) {
                    console.log('Fail');
                    console.log(jqXHR);
                    sendButton.button('reset');
                    tagitInput.parent().addClass('has-error');
                    showEmailErrorMessage();
                });

            });
        </script>
    </body>
</html>
